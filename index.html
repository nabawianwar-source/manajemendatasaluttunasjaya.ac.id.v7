import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import {
    getFirestore, collection, doc, setDoc, updateDoc, deleteDoc,
    onSnapshot, runTransaction
} from 'firebase/firestore';
import {
    Edit, Trash2, Plus, Filter, FileText, FilePlus,
    Upload, Save, ChevronRight, X, Check, Eye
} from 'lucide-react';

// Fungsi bantuan untuk format mata uang
const formatRupiah = (number) => {
    if (typeof number !== 'number' || isNaN(number)) return 'Rp0';
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(number);
};

// Fungsi bantuan untuk format tanggal
const formatDate = (dateString) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
};

const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [students, setStudents] = useState([]);
    const [currentSection, setCurrentSection] = useState('mahasiswa');
    const [loading, setLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [error, setError] = useState(null);
    const [xlsxLoaded, setXlsxLoaded] = useState(false);
    const [pdfLoaded, setPdfLoaded] = useState(false);
    const [totalIncome, setTotalIncome] = useState(0);
    // State baru untuk memisahkan total pemasukan
    const [totalIncomeNewStudents, setTotalIncomeNewStudents] = useState(0);
    const [totalIncomeOldStudents, setTotalIncomeOldStudents] = useState(0);

    // State untuk form mahasiswa
    const [mahasiswaForm, setMahasiswaForm] = useState({
        id: null,
        nim: '',
        nama: '',
        jurusan: '',
        status: 'Mahasiswa Baru',
        jenisLayanan: 'Non-SIPAS',
        semester: 1,
        lokasiUjian: ''
    });

    // State untuk filter
    const [currentFilter, setCurrentFilter] = useState('Semua');
    const [currentKeuanganFilter, setCurrentKeuanganFilter] = useState('Semua');

    // State untuk form pembayaran
    const [paymentSearchQuery, setPaymentSearchQuery] = useState('');
    const [paymentStudent, setPaymentStudent] = useState(null);
    const [paymentForm, setPaymentForm] = useState({
        nominalSalut: '',
        cicilSalut: '',
        keteranganSalut: '',
        tanggalSalut: '',
        tanggalSpp: ''
    });

    // State untuk modal
    const [showDeleteModal, setShowDeleteModal] = useState(false);
    const [studentToDelete, setStudentToDelete] = useState(null);
    const [showMessageModal, setShowMessageModal] = useState(false);
    const [messageModalContent, setMessageModalContent] = useState({ title: '', text: '', type: 'info' });
    const [showEditPaymentModal, setShowEditPaymentModal] = useState(false);
    const [editPaymentStudent, setEditPaymentStudent] = useState(null);
    const [editPaymentAmount, setEditPaymentAmount] = useState('');
    
    // State baru untuk modal laporan keuangan
    const [showReportModal, setShowReportModal] = useState(false);
    const [reportStudent, setReportStudent] = useState(null);
    
    // State untuk fitur impor Excel
    const [importedData, setImportedData] = useState([]);
    const [showImportModal, setShowImportModal] = useState(false);
    
    // State untuk loading PDF
    const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
    const [isGeneratingReportPdf, setIsGeneratingReportPdf] = useState(false);
    const [isGeneratingKeuanganPdf, setIsGeneratingKeuanganPdf] = useState(false);

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Inisialisasi dan Autentikasi Firebase
    useEffect(() => {
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);
            setAuth(authInstance);
            setDb(dbInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    console.log('Autentikasi Firebase berhasil:', user.uid);
                } else {
                    console.log('Pengguna tidak terautentikasi, masuk secara anonim...');
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(authInstance, token);
                        } else {
                            await signInAnonymously(authInstance);
                        }
                    } catch (e) {
                        console.error('Gagal masuk:', e);
                        setError('Gagal masuk ke database. Mohon muat ulang halaman.');
                    }
                }
            });
            return () => unsubscribe();
        } catch (e) {
            console.error('Inisialisasi Firebase gagal:', e);
            setError('Gagal menginisialisasi Firebase. Pastikan konfigurasi sudah benar.');
            setLoading(false);
        }
    }, []);
    
    // Muat library XLSX dan PDF secara dinamis
    useEffect(() => {
        // Muat library XLSX
        const scriptXlsx = document.createElement('script');
        scriptXlsx.src = "https://unpkg.com/xlsx/dist/xlsx.full.min.js";
        scriptXlsx.onload = () => {
            console.log("Library XLSX berhasil dimuat.");
            setXlsxLoaded(true);
        };
        scriptXlsx.onerror = () => {
            console.error("Gagal memuat library XLSX.");
            setError("Gagal memuat library impor/ekspor Excel. Mohon muat ulang halaman.");
        };
        document.head.appendChild(scriptXlsx);

        // Muat library jsPDF
        const scriptJsPdf = document.createElement('script');
        scriptJsPdf.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
        scriptJsPdf.onload = () => {
             // Muat library jsPDF-autotable setelah jsPDF
             const scriptAutoTable = document.createElement('script');
             scriptAutoTable.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js";
             scriptAutoTable.onload = () => {
                 console.log("Library jsPDF dan jsPDF-autotable berhasil dimuat.");
                 setPdfLoaded(true);
             };
             document.head.appendChild(scriptAutoTable);
        };
        scriptJsPdf.onerror = () => {
            console.error("Gagal memuat library jsPDF.");
            setError("Gagal memuat library PDF. Mohon muat ulang halaman.");
        };
        document.head.appendChild(scriptJsPdf);

        return () => {
            document.head.removeChild(scriptXlsx);
            if (document.head.contains(scriptJsPdf)) {
                document.head.removeChild(scriptJsPdf);
            }
        };
    }, []);

    // Handler untuk memperbarui siklus pembayaran
    const updatePaymentCycle = useCallback(async (student) => {
        if (!db || !userId || !student || !student.currentPaymentCycleId) return;

        const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, student.id);
        const now = new Date();

        try {
            await runTransaction(db, async (transaction) => {
                const currentStudentDoc = await transaction.get(studentDocRef);
                if (!currentStudentDoc.exists()) {
                    throw new Error("Dokumen mahasiswa tidak ada!");
                }

                const currentCycle = currentStudentDoc.data().currentPaymentCycle;
                const cycleEndDate = new Date(currentCycle.periodEnd);

                // Periksa kembali apakah siklus telah berakhir
                if (now > cycleEndDate) {
                    console.log(`Menjalankan transaksi untuk memperbarui siklus pembayaran untuk ${student.nama}...`);

                    // Arsipkan siklus pembayaran lama
                    const oldCycleDocRef = doc(studentDocRef, 'paymentCycles', currentCycle.id);
                    transaction.update(oldCycleDocRef, { isArchived: true });

                    // Buat siklus pembayaran baru
                    const newCycleDocRef = doc(collection(studentDocRef, 'paymentCycles'));
                    const newCycle = {
                        id: newCycleDocRef.id,
                        periodStart: now.toISOString(),
                        periodEnd: new Date(new Date().setMonth(now.getMonth() + 6)).toISOString(),
                        nominalSalut: 0,
                        cicilSalut: 0,
                        sisaSalut: 0,
                        keteranganSalut: '',
                        tanggalSalut: '',
                        tanggalSpp: '',
                        isArchived: false
                    };

                    transaction.set(newCycleDocRef, newCycle);
                    
                    // Perbarui dokumen utama mahasiswa dengan siklus baru
                    transaction.update(studentDocRef, {
                        currentPaymentCycleId: newCycle.id,
                        currentPaymentCycle: newCycle
                    });
                    
                    console.log(`Siklus pembayaran baru untuk ${student.nama} berhasil dibuat.`);
                }
            });
        } catch (e) {
            console.error("Gagal memperbarui siklus pembayaran dalam transaksi: ", e);
            // Anda dapat menampilkan pesan kesalahan di UI di sini jika diperlukan
        }
    }, [db, userId, appId]);

    // Handler untuk memperbarui semester
    const updateSemester = useCallback(async (student) => {
        if (!db || !userId || !student) return;
        
        const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, student.id);
        const now = new Date();
        const semesterStartDate = new Date(student.semesterStartDate);
        
        // Cek jika sudah 6 bulan berlalu sejak semester dimulai dan semester belum 8
        const sixMonthsLater = new Date(new Date(student.semesterStartDate).setMonth(semesterStartDate.getMonth() + 6));
        
        if (student.semester < 8 && now > sixMonthsLater) {
            console.log(`Menjalankan transaksi untuk memperbarui semester untuk ${student.nama}...`);
            try {
                await runTransaction(db, async (transaction) => {
                    const currentStudentDoc = await transaction.get(studentDocRef);
                    if (!currentStudentDoc.exists()) {
                        throw new Error("Dokumen mahasiswa tidak ada!");
                    }
                    
                    const newSemester = currentStudentDoc.data().semester + 1;
                    
                    if (newSemester <= 8) {
                        transaction.update(studentDocRef, {
                            semester: newSemester,
                            semesterStartDate: now.toISOString(), // Atur tanggal mulai semester yang baru
                            status: newSemester > 1 ? 'Aktif' : 'Mahasiswa Baru' // Atur status jika perlu
                        });
                        console.log(`Semester ${student.nama} berhasil diperbarui menjadi ${newSemester}.`);
                    }
                });
            } catch (e) {
                console.error("Gagal memperbarui semester dalam transaksi: ", e);
            }
        }
    }, [db, userId, appId]);

    // Ambil data dari Firestore, hitung total pemasukan, dan jalankan formula siklus 6 bulan
    useEffect(() => {
        if (!db || !userId) return;

        const studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
        const unsubscribe = onSnapshot(studentsCollectionRef, (snapshot) => {
            const fetchedStudents = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            fetchedStudents.forEach(student => {
                // Periksa dan perbarui siklus pembayaran
                if (student.currentPaymentCycle?.periodEnd) {
                    const cycleEndDate = new Date(student.currentPaymentCycle.periodEnd);
                    if (new Date() > cycleEndDate) {
                        updatePaymentCycle(student);
                    }
                }
                
                // Periksa dan perbarui semester
                if (student.semesterStartDate) {
                    updateSemester(student);
                }
            });

            // Filter mahasiswa untuk perhitungan keuangan (hanya Aktif dan Mahasiswa Baru)
            const financiallyActiveStudents = fetchedStudents.filter(s => s.status === 'Aktif' || s.status === 'Mahasiswa Baru');
            
            let totalIncomeAll = 0;
            let totalIncomeNew = 0;
            let totalIncomeOld = 0;

            financiallyActiveStudents.forEach(student => {
                const cicilan = student.currentPaymentCycle?.cicilSalut || 0;
                totalIncomeAll += cicilan;
                if (student.status === 'Mahasiswa Baru') {
                    totalIncomeNew += cicilan;
                } else if (student.status === 'Aktif') {
                    totalIncomeOld += cicilan;
                }
            });
            
            setStudents(fetchedStudents); // Tetapkan semua mahasiswa untuk tab Mahasiswa
            setTotalIncome(totalIncomeAll);
            setTotalIncomeNewStudents(totalIncomeNew);
            setTotalIncomeOldStudents(totalIncomeOld);
            
            setLoading(false);
        }, (err) => {
            console.error('Error fetching students:', err);
            setError('Gagal memuat data mahasiswa dari database.');
            setLoading(false);
        });

        return () => unsubscribe();
    }, [db, userId, appId, updatePaymentCycle, updateSemester]);

    // Handler untuk menampilkan modal pesan
    const showMessage = (title, text, type = 'info') => {
        setMessageModalContent({ title, text, type });
        setShowMessageModal(true);
    };

    // Handler form mahasiswa
    const handleMahasiswaFormChange = (e) => {
        const { name, value } = e.target;
        setMahasiswaForm(prev => ({ ...prev, [name]: value }));
    };

    const resetMahasiswaForm = () => {
        setMahasiswaForm({
            id: null,
            nim: '',
            nama: '',
            jurusan: '',
            status: 'Mahasiswa Baru',
            jenisLayanan: 'Non-SIPAS',
            semester: 1,
            lokasiUjian: ''
        });
    };

    const handleMahasiswaSubmit = async (e) => {
        e.preventDefault();
        setIsSaving(true);
        if (!db || !userId) return;

        const studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
        const nimToCheck = mahasiswaForm.nim.trim();

        try {
            if (mahasiswaForm.id) {
                // Perbarui mahasiswa
                // Cek apakah NIM diubah menjadi NIM yang sudah ada (milik mahasiswa lain)
                const nimExists = students.some(student => student.nim === nimToCheck && student.id !== mahasiswaForm.id);
                if (nimExists) {
                    showMessage('Error', 'NIM sudah digunakan oleh mahasiswa lain.', 'error');
                    setIsSaving(false);
                    return;
                }

                const docRef = doc(db, studentsCollectionRef.path, mahasiswaForm.id);
                await updateDoc(docRef, {
                    nim: nimToCheck,
                    nama: mahasiswaForm.nama,
                    jurusan: mahasiswaForm.jurusan,
                    status: mahasiswaForm.status,
                    jenisLayanan: mahasiswaForm.jenisLayanan,
                    semester: parseInt(mahasiswaForm.semester),
                    lokasiUjian: mahasiswaForm.lokasiUjian,
                });
                showMessage('Sukses', 'Data mahasiswa berhasil diperbarui!', 'success');
            } else {
                // Tambah mahasiswa baru
                // Cek apakah NIM sudah ada
                const nimExists = students.some(student => student.nim === nimToCheck);
                if (nimExists) {
                    showMessage('Error', 'NIM sudah terdaftar. Mohon gunakan NIM lain.', 'error');
                    setIsSaving(false);
                    return;
                }

                const newDocRef = doc(studentsCollectionRef);
                const now = new Date();
                const initialPaymentCycleId = doc(collection(newDocRef, 'paymentCycles')).id;
                const initialPaymentCycle = {
                    id: initialPaymentCycleId,
                    periodStart: now.toISOString(),
                    periodEnd: new Date(new Date().setMonth(now.getMonth() + 6)).toISOString(),
                    nominalSalut: 0,
                    cicilSalut: 0,
                    sisaSalut: 0,
                    keteranganSalut: '',
                    tanggalSalut: '',
                    tanggalSpp: '',
                    isArchived: false,
                };
                
                await setDoc(doc(newDocRef, 'paymentCycles', initialPaymentCycleId), initialPaymentCycle);

                await setDoc(newDocRef, {
                    nim: nimToCheck,
                    nama: mahasiswaForm.nama,
                    jurusan: mahasiswaForm.jurusan,
                    status: mahasiswaForm.status,
                    jenisLayanan: mahasiswaForm.jenisLayanan,
                    semester: parseInt(mahasiswaForm.semester),
                    lokasiUjian: mahasiswaForm.lokasiUjian,
                    semesterStartDate: now.toISOString(), // Tambahkan tanggal mulai semester
                    currentPaymentCycleId: initialPaymentCycle.id,
                    currentPaymentCycle: initialPaymentCycle
                });
                showMessage('Sukses', 'Mahasiswa baru berhasil ditambahkan!', 'success');
            }
            resetMahasiswaForm();
        } catch (e) {
            console.error('Error adding/updating document:', e);
            showMessage('Error', 'Gagal menyimpan data ke database.', 'error');
        } finally {
            setIsSaving(false);
        }
    };

    const editMahasiswa = (studentId) => {
        const studentToEdit = students.find(s => s.id === studentId);
        if (studentToEdit) {
            setMahasiswaForm({
                id: studentToEdit.id,
                nim: studentToEdit.nim,
                nama: studentToEdit.nama,
                jurusan: studentToEdit.jurusan,
                status: studentToEdit.status,
                jenisLayanan: studentToEdit.jenisLayanan,
                semester: studentToEdit.semester,
                lokasiUjian: studentToEdit.lokasiUjian
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };

    const handleDelete = async () => {
        if (!studentToDelete || !db || !userId) return;
        setIsSaving(true);
        try {
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/students`, studentToDelete));
            showMessage('Sukses', 'Data mahasiswa berhasil dihapus.', 'success');
        } catch (e) {
            console.error('Error deleting document:', e);
            showMessage('Error', 'Gagal menghapus data dari database.', 'error');
        } finally {
            setIsSaving(false);
            setShowDeleteModal(false);
            setStudentToDelete(null);
        }
    };

    // Handler form pembayaran
    const searchStudentForPayment = () => {
        const query = paymentSearchQuery.toLowerCase();
        const foundStudent = students.find(s => s.nim.toLowerCase() === query || s.nama.toLowerCase().includes(query));
        if (foundStudent) {
            setPaymentStudent(foundStudent);
            setPaymentForm({
                nominalSalut: foundStudent.currentPaymentCycle.nominalSalut || '',
                cicilSalut: foundStudent.currentPaymentCycle.cicilSalut || '',
                keteranganSalut: foundStudent.currentPaymentCycle.keteranganSalut || '',
                tanggalSalut: foundStudent.currentPaymentCycle.tanggalSalut || '',
                tanggalSpp: foundStudent.currentPaymentCycle.tanggalSpp || ''
            });
        } else {
            setPaymentStudent(null);
            showMessage('Error', 'Mahasiswa tidak ditemukan.', 'error');
        }
    };

    const handlePaymentFormChange = (e) => {
        const { name, value } = e.target;
        setPaymentForm(prev => ({ ...prev, [name]: value }));
    };

    const updateSisaSalut = () => {
        const nominal = parseFloat(paymentForm.nominalSalut) || 0;
        const cicil = parseFloat(paymentForm.cicilSalut) || 0;
        return Math.round((nominal - cicil) * 100) / 100;
    };

    const savePayment = async (e) => {
        e.preventDefault();
        setIsSaving(true);

        if (!paymentStudent || !db || !userId) {
            showMessage('Peringatan', 'Mohon cari mahasiswa terlebih dahulu.', 'warning');
            setIsSaving(false);
            return;
        }

        const nominalSalut = parseFloat(paymentForm.nominalSalut) || 0;
        const cicilSalut = parseFloat(paymentForm.cicilSalut) || 0;

        if (nominalSalut === 0) {
            showMessage('Peringatan', 'Mohon pilih nominal layanan salut.', 'warning');
            setIsSaving(false);
            return;
        }

        if (cicilSalut > nominalSalut) {
            showMessage('Peringatan', 'Cicilan tidak boleh lebih besar dari nominal total.', 'warning');
            setIsSaving(false);
            return;
        }

        try {
            const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, paymentStudent.id);
            const paymentCycleDocRef = doc(studentDocRef, 'paymentCycles', paymentStudent.currentPaymentCycleId);

            const updatedPaymentCycle = {
                ...paymentStudent.currentPaymentCycle,
                nominalSalut,
                cicilSalut,
                sisaSalut: Math.round((nominalSalut - cicilSalut) * 100) / 100,
                keteranganSalut: paymentForm.keteranganSalut,
                tanggalSalut: paymentForm.tanggalSalut,
                tanggalSpp: paymentForm.tanggalSpp,
            };

            await updateDoc(paymentCycleDocRef, updatedPaymentCycle);
            await updateDoc(studentDocRef, { currentPaymentCycle: updatedPaymentCycle });

            showMessage('Sukses', `Pembayaran untuk ${paymentStudent.nama} berhasil disimpan!`, 'success');
            setPaymentStudent(null);
            setPaymentSearchQuery('');
        } catch (e) {
            console.error('Error saving payment:', e);
            showMessage('Error', 'Gagal menyimpan pembayaran ke database.', 'error');
        } finally {
            setIsSaving(false);
        }
    };

    // Handler modal edit pembayaran
    const showEditPayment = (student) => {
        setEditPaymentStudent(student);
        setEditPaymentAmount(student.currentPaymentCycle.cicilSalut);
        setShowEditPaymentModal(true);
    };

    const updateEditedPayment = async (e) => {
        e.preventDefault();
        setIsSaving(true);
        if (!editPaymentStudent || !db || !userId) return;

        const nominalTotal = editPaymentStudent.currentPaymentCycle.nominalSalut;
        const newCicil = parseFloat(editPaymentAmount) || 0;

        if (newCicil > nominalTotal) {
            showMessage('Peringatan', 'Total cicilan tidak boleh melebihi nominal total.', 'warning');
            setIsSaving(false);
            return;
        }

        try {
            const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, editPaymentStudent.id);
            const paymentCycleDocRef = doc(studentDocRef, 'paymentCycles', editPaymentStudent.currentPaymentCycleId);
            
            const sisa = Math.round((nominalTotal - newCicil) * 100) / 100;
            const updatedPaymentCycle = {
                ...editPaymentStudent.currentPaymentCycle,
                cicilSalut: newCicil,
                sisaSalut: sisa,
            };

            await updateDoc(paymentCycleDocRef, updatedPaymentCycle);
            await updateDoc(studentDocRef, { currentPaymentCycle: updatedPaymentCycle });

            setShowEditPaymentModal(false);
            showMessage('Sukses', `Pembayaran untuk ${editPaymentStudent.nama} berhasil diperbarui.`, 'success');
        } catch (e) {
            console.error('Error updating payment:', e);
            showMessage('Error', 'Gagal menyimpan perubahan pembayaran.', 'error');
        } finally {
            setIsSaving(false);
        }
    };

    const markAsLunas = async () => {
        setIsSaving(true);
        if (!editPaymentStudent || !db || !userId) return;
        try {
            const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, editPaymentStudent.id);
            const paymentCycleDocRef = doc(studentDocRef, 'paymentCycles', editPaymentStudent.currentPaymentCycleId);

            const nominalTotal = editPaymentStudent.currentPaymentCycle.nominalSalut;
            const updatedPaymentCycle = {
                ...editPaymentStudent.currentPaymentCycle,
                cicilSalut: nominalTotal,
                sisaSalut: 0,
            };

            await updateDoc(paymentCycleDocRef, updatedPaymentCycle);
            await updateDoc(studentDocRef, { currentPaymentCycle: updatedPaymentCycle });

            setShowEditPaymentModal(false);
            showMessage('Sukses', `Pembayaran untuk ${editPaymentStudent.nama} ditandai lunas.`, 'success');
        } catch (e) {
            console.error('Error marking as Lunas:', e);
            showMessage('Error', 'Gagal menandai pembayaran lunas.', 'error');
        } finally {
            setIsSaving(false);
        }
    };
    
    // Handler untuk menampilkan modal laporan
    const showFinancialReport = (student) => {
        setReportStudent(student);
        setShowReportModal(true);
    };

    const getFilteredStudents = useCallback(() => {
        let filtered = students;
        if (currentFilter !== 'Semua') {
            filtered = students.filter(s => s.status === currentFilter);
        }
        return filtered;
    }, [students, currentFilter]);

    const getFilteredKeuangan = useCallback(() => {
        // Pertama, filter hanya untuk mahasiswa 'Aktif' dan 'Mahasiswa Baru'
        let baseFiltered = students.filter(s => s.status === 'Aktif' || s.status === 'Mahasiswa Baru');

        // Kemudian, terapkan filter status pembayaran
        if (currentKeuanganFilter === 'Lunas') {
            return baseFiltered.filter(s => s.currentPaymentCycle?.sisaSalut === 0 && s.currentPaymentCycle?.nominalSalut > 0);
        } else if (currentKeuanganFilter === 'Belum Lunas') {
            return baseFiltered.filter(s => s.currentPaymentCycle?.sisaSalut > 0 && s.currentPaymentCycle?.nominalSalut > 0);
        }
        // Jika filter 'Semua', kembalikan daftar yang sudah difilter berdasarkan status mahasiswa
        return baseFiltered;
    }, [students, currentKeuanganFilter]);

    // Fungsi untuk mengunduh template Excel
    const handleDownloadSampleTemplate = () => {
        if (!window.XLSX) {
            showMessage('Peringatan', 'Library Excel belum siap. Mohon coba sebentar lagi.', 'warning');
            return;
        }

        const headers = ["nim", "nama", "jurusan", "status", "jenisLayanan", "semester", "lokasiUjian"];
        const sampleData = [
            ["2023001", "Andi Pratama", "Teknik Informatika", "Mahasiswa Baru", "SIPAS Penuh", 1, "Jakarta"],
            ["2023002", "Budi Santoso", "Ilmu Komunikasi", "Aktif", "SIPAS Semi", 3, "Bandung"],
            ["2022003", "Citra Lestari", "Teknik Informatika", "Cuti", "Non-SIPAS", 5, "Surabaya"],
            ["2022004", "Dewi Sartika", "Ilmu Komunikasi", "Aktif", "SIPAS Non-TTM", 4, "Yogyakarta"]
        ];

        const worksheet = window.XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
        const workbook = window.XLSX.utils.book_new();
        window.XLSX.utils.book_append_sheet(workbook, worksheet, "Data Mahasiswa");
        window.XLSX.writeFile(workbook, "contoh_template_mahasiswa.xlsx");
    };

    // Handler untuk impor file Excel
    const handleFileUpload = (e) => {
        if (!window.XLSX) {
            showMessage('Peringatan', 'Library Excel belum siap. Mohon coba sebentar lagi.', 'warning');
            return;
        }

        const file = e.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = window.XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = window.XLSX.utils.sheet_to_json(sheet, {
                    header: [
                        "nim", "nama", "jurusan", "status", "jenisLayanan", "semester", "lokasiUjian"
                    ],
                    range: 1 // Mulai dari baris kedua untuk mengabaikan header
                });
                
                // Pastikan data tidak kosong
                if (json.length > 0) {
                    setImportedData(json);
                    setShowImportModal(true);
                } else {
                    showMessage('Peringatan', 'File Excel kosong atau tidak ada data yang ditemukan.', 'warning');
                }
            } catch (err) {
                console.error("Error reading Excel file:", err);
                showMessage('Error', 'Gagal membaca file Excel. Pastikan format file sudah benar.', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
        e.target.value = null; // Reset input file
    };

    // Handler untuk menyimpan data yang diimpor ke Firestore
    const saveImportedData = async () => {
        if (importedData.length === 0 || !db || !userId) {
            showMessage('Peringatan', 'Tidak ada data untuk disimpan.', 'warning');
            return;
        }
        setIsSaving(true);
        setShowImportModal(false);

        const studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
        
        // Buat set NIM yang sudah ada untuk pengecekan cepat
        const existingNims = new Set(students.map(s => s.nim));
        const importedNims = new Set();
        
        // Filter data impor untuk menghindari duplikasi
        const uniqueNewStudents = importedData.filter(student => {
            const nim = String(student.nim || '').trim();
            if (!nim) return false; // Abaikan baris dengan NIM kosong

            // Cek duplikasi di dalam file Excel dan di database
            if (importedNims.has(nim) || existingNims.has(nim)) {
                return false;
            }
            importedNims.add(nim);
            return true;
        });

        const duplicateCount = importedData.length - uniqueNewStudents.length;
        
        if (uniqueNewStudents.length === 0) {
            showMessage('Informasi', 'Tidak ada data baru untuk diimpor. Semua NIM yang diunggah sudah ada atau kosong.', 'info');
            setIsSaving(false);
            setImportedData([]);
            return;
        }
        
        const savePromises = uniqueNewStudents.map(async (student) => {
            const newDocRef = doc(studentsCollectionRef);
            const now = new Date();
            const initialPaymentCycleId = doc(collection(newDocRef, 'paymentCycles')).id;
            const initialPaymentCycle = {
                id: initialPaymentCycleId,
                periodStart: now.toISOString(),
                periodEnd: new Date(new Date().setMonth(now.getMonth() + 6)).toISOString(),
                nominalSalut: 0,
                cicilSalut: 0,
                sisaSalut: 0,
                keteranganSalut: '',
                tanggalSalut: '',
                tanggalSpp: '',
                isArchived: false,
            };

            await setDoc(doc(newDocRef, 'paymentCycles', initialPaymentCycleId), initialPaymentCycle);
            await setDoc(newDocRef, {
                nim: String(student.nim || '').trim(),
                nama: String(student.nama || ''),
                jurusan: String(student.jurusan || ''),
                status: String(student.status || 'Mahasiswa Baru'),
                jenisLayanan: String(student.jenisLayanan || 'Non-SIPAS'),
                semester: parseInt(student.semester) || 1,
                lokasiUjian: String(student.lokasiUjian || ''),
                semesterStartDate: now.toISOString(), // Tambahkan tanggal mulai semester
                currentPaymentCycleId: initialPaymentCycleId,
                currentPaymentCycle: initialPaymentCycle
            });
        });

        try {
            await Promise.all(savePromises);
            let successMessage = `${uniqueNewStudents.length} data mahasiswa baru berhasil diimpor!`;
            if (duplicateCount > 0) {
                successMessage += ` ${duplicateCount} data duplikat atau NIM kosong diabaikan.`;
            }
            showMessage('Sukses', successMessage, 'success');
        } catch (e) {
            console.error('Error importing data:', e);
            showMessage('Error', 'Gagal mengimpor data ke database.', 'error');
        } finally {
            setIsSaving(false);
            setImportedData([]);
        }
    };
    
    // Fungsi untuk membuat PDF berdasarkan filter saat ini
    const generateCategoryPDF = () => {
        if (!pdfLoaded || !window.jspdf || !window.jspdf.jsPDF) {
            showMessage('Peringatan', 'Library PDF belum siap. Mohon coba sebentar lagi.', 'warning');
            return;
        }

        setIsGeneratingPdf(true);
        
        // Timeout singkat untuk memastikan UI loading diperbarui
        setTimeout(() => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Ambil data mahasiswa yang difilter dari state
            const filteredStudents = getFilteredStudents();
            
            // Tambahkan kolom 'No.'
            const tableHeaders = ['No.', 'NIM', 'Nama', 'Jurusan', 'Status', 'Semester', 'Lokasi Ujian'];

            let subtitleText;
            let fileName;
            
            // Sesuaikan header dan nama file berdasarkan filter aktif
            const baseTitle = "SALUT TUNAS JAYA";

            if (currentFilter === 'Mahasiswa Baru') {
                subtitleText = "DAFTAR MAHASISWA BARU";
                fileName = 'Daftar_Mahasiswa_Baru.pdf';
            } else if (currentFilter === 'Semua') {
                subtitleText = "DAFTAR SEMUA MAHASISWA";
                fileName = 'Daftar_Semua_Mahasiswa.pdf';
            } else {
                subtitleText = `DAFTAR MAHASISWA ${currentFilter.toUpperCase()}`;
                fileName = `Daftar_Mahasiswa_${currentFilter.replace(/\s/g, '_')}.pdf`;
            }
            
            // Tambahkan header ke dokumen dan pastikan di tengah
            doc.setFontSize(16);
            doc.text(baseTitle, doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });
            doc.setFontSize(14);
            doc.text(subtitleText, doc.internal.pageSize.getWidth() / 2, 28, { align: "center" });
            doc.line(10, 35, doc.internal.pageSize.getWidth() - 10, 35); // Garis pemisah

            // Gunakan jspdf-autotable untuk membuat tabel dari data yang difilter
            doc.autoTable({
                startY: 40, // Jarak dari atas halaman
                head: [tableHeaders],
                // Tambahkan penomoran otomatis di sini
                body: filteredStudents.map((s, i) => [i + 1, s.nim, s.nama, s.jurusan, s.status, s.semester, s.lokasiUjian]),
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80] },
                margin: { top: 35 },
                styles: { font: 'Inter', fontSize: 10 }
            });

            // Unduh file PDF
            doc.save(fileName);
            setIsGeneratingPdf(false);
        }, 100);
    };

    // Fungsi untuk membuat PDF Laporan Keuangan individual
    const generateFinancialReportPdf = (student) => {
        if (!pdfLoaded || !window.jspdf || !window.jspdf.jsPDF) {
            showMessage('Peringatan', 'Library PDF belum siap. Mohon coba sebentar lagi.', 'warning');
            return;
        }
        
        setIsGeneratingReportPdf(true);

        setTimeout(() => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18);
            doc.text("Laporan Keuangan Mahasiswa", 14, 20);
            doc.setFontSize(12);
            doc.text("SALUT Tunas Jaya", 14, 26);
            doc.line(10, 30, doc.internal.pageSize.getWidth() - 10, 30);
            
            // Info Mahasiswa
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Nama: ${student.nama}`, 14, 40);
            doc.text(`NIM: ${student.nim}`, 14, 46);
            doc.text(`Jurusan: ${student.jurusan}`, 14, 52);
            doc.text(`Semester: ${student.semester}`, 14, 58);
            
            // Info Pembayaran
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text("Detail Pembayaran Layanan SALUT", 14, 70);
            
            const paymentCycle = student.currentPaymentCycle || {};
            const nominal = paymentCycle.nominalSalut || 0;
            const cicil = paymentCycle.cicilSalut || 0;
            const sisa = nominal - cicil;
            const statusText = sisa === 0 ? "LUNAS" : "BELUM LUNAS";
            const statusColor = sisa === 0 ? [16, 185, 129] : [239, 68, 68];

            const tableData = [
                ['Layanan SALUT', formatRupiah(nominal), { content: statusText, style: { textColor: statusColor } }, paymentCycle.keteranganSalut || '-']
            ];

            doc.autoTable({
                startY: 75,
                head: [['Jenis Biaya', 'Jumlah (Rp)', 'Status', 'Keterangan']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80] },
                styles: { fontSize: 10 }
            });
            
            // Ringkasan Pembayaran
            let finalY = doc.autoTable.previous.finalY;
            finalY += 10;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text("Ringkasan:", 14, finalY);
            doc.setFont('helvetica', 'normal');
            doc.text(`Total Biaya: ${formatRupiah(nominal)}`, 14, finalY + 6);
            doc.text(`Total Pembayaran Diterima: ${formatRupiah(cicil)}`, 14, finalY + 12);
            doc.text(`Sisa Kewajiban: ${formatRupiah(sisa)}`, 14, finalY + 18);

            doc.save(`Laporan_Keuangan_${student.nim}.pdf`);
            setIsGeneratingReportPdf(false);
        }, 100);
    };

    // Fungsi baru untuk membuat PDF Laporan Keuangan berdasarkan filter
    const generateKeuanganPDF = () => {
        if (!pdfLoaded || !window.jspdf || !window.jspdf.jsPDF) {
            showMessage('Peringatan', 'Library PDF belum siap. Mohon coba sebentar lagi.', 'warning');
            return;
        }

        setIsGeneratingKeuanganPdf(true);

        setTimeout(() => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const filteredKeuangan = getFilteredKeuangan();
            const tableHeaders = ['No.', 'NIM', 'Nama', 'Nominal Salut', 'Total Cicilan', 'Sisa', 'Keterangan'];

            let subtitleText;
            let fileName;
            const baseTitle = "SALUT TUNAS JAYA";

            if (currentKeuanganFilter === 'Semua') {
                subtitleText = "LAPORAN KEUANGAN MAHASISWA AKTIF";
                fileName = 'Laporan_Keuangan_Semua_Aktif.pdf';
            } else {
                subtitleText = `LAPORAN KEUANGAN MAHASISWA (STATUS: ${currentKeuanganFilter.toUpperCase()})`;
                fileName = `Laporan_Keuangan_${currentKeuanganFilter.replace(/\s/g, '_')}.pdf`;
            }
            
            doc.setFontSize(16);
            doc.text(baseTitle, doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });
            doc.setFontSize(14);
            doc.text(subtitleText, doc.internal.pageSize.getWidth() / 2, 28, { align: "center" });
            doc.line(10, 35, doc.internal.pageSize.getWidth() - 10, 35);

            doc.autoTable({
                startY: 40,
                head: [tableHeaders],
                body: filteredKeuangan.map((s, i) => [
                    i + 1,
                    s.nim,
                    s.nama,
                    formatRupiah(s.currentPaymentCycle?.nominalSalut || 0),
                    formatRupiah(s.currentPaymentCycle?.cicilSalut || 0),
                    formatRupiah(s.currentPaymentCycle?.sisaSalut || 0),
                    s.currentPaymentCycle?.keteranganSalut || '-'
                ]),
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80] },
                margin: { top: 35 },
                styles: { font: 'Inter', fontSize: 10 }
            });

            doc.save(fileName);
            setIsGeneratingKeuanganPdf(false);
        }, 100);
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen">
                <div className="text-center">
                    <div className="w-16 h-16 border-4 border-blue-500 border-solid rounded-full animate-spin border-t-transparent"></div>
                    <p className="mt-4 text-xl font-semibold text-gray-700">Memuat data...</p>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="flex items-center justify-center min-h-screen p-6">
                <div className="p-8 text-center bg-red-100 border-4 border-red-400 rounded-lg shadow-md">
                    <h2 className="mb-4 text-2xl font-bold text-red-700">Terjadi Kesalahan</h2>
                    <p className="text-red-600">{error}</p>
                    <p className="mt-4 text-sm text-red-500">Mohon muat ulang halaman ini.</p>
                </div>
            </div>
        );
    }

    return (
        <div className="bg-gray-100 font-sans p-6 md:p-12 min-h-screen">
            <div className="max-w-7xl mx-auto mb-6">
                <h1 className="text-3xl md:text-4xl font-bold text-center text-blue-600 mb-4">Manajemen Mahasiswa Salut Tunas Jaya</h1>
                <nav className="flex justify-center space-x-4 mb-8">
                    <button
                        onClick={() => setCurrentSection('mahasiswa')}
                        className={`px-6 py-2 rounded-lg font-semibold transition-colors ${currentSection === 'mahasiswa' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                        Mahasiswa
                    </button>
                    <button
                        onClick={() => setCurrentSection('pembayaran')}
                        className={`px-6 py-2 rounded-lg font-semibold transition-colors ${currentSection === 'pembayaran' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                        Pembayaran
                    </button>
                    <button
                        onClick={() => setCurrentSection('laporan-keuangan')}
                        className={`px-6 py-2 rounded-lg font-semibold transition-colors ${currentSection === 'laporan-keuangan' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                        Laporan Keuangan
                    </button>
                </nav>
            </div>

            {/* Bagian Daftar Mahasiswa */}
            {currentSection === 'mahasiswa' && (
                <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-10 mb-10">
                    <h2 className="text-2xl font-semibold mb-4 text-gray-900">Tambah/Edit Mahasiswa</h2>
                    <form onSubmit={handleMahasiswaSubmit} className="space-y-4 mb-8">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">NIM</label>
                                <input type="text" name="nim" value={mahasiswaForm.nim} onChange={handleMahasiswaFormChange} required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Nama</label>
                                <input type="text" name="nama" value={mahasiswaForm.nama} onChange={handleMahasiswaFormChange} required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Jurusan</label>
                                <select name="jurusan" value={mahasiswaForm.jurusan} onChange={handleMahasiswaFormChange} required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Pilih Jurusan --</option>
                                    <optgroup label="FAKULTAS HUKUM ILMU SOSIAL DAN ILMU POLITIK (FHISIP)">
                                        <option value="Perpajakan (D-III)">Perpajakan (D-III)</option>
                                        <option value="Perpajakan (S1)">Perpajakan (S1)</option>
                                        <option value="Administrasi Publik (S1)">Administrasi Publik (S1)</option>
                                        <option value="Administrasi Publik (Minat Adm. & Manajemen Kepegawaian) (S1)">Administrasi Publik (Minat Adm. & Manajemen Kepegawaian) (S1)</option>
                                        <option value="Administrasi Bisnis (S1)">Administrasi Bisnis (S1)</option>
                                        <option value="Ilmu Pemerintahan (S1)">Ilmu Pemerintahan (S1)</option>
                                        <option value="Kearsipan (D-IV)">Kearsipan (D-IV)</option>
                                        <option value="Ilmu Komunikasi (S1)">Ilmu Komunikasi (S1)</option>
                                        <option value="Ilmu Perpustakaan (S1)">Ilmu Perpustakaan (S1)</option>
                                        <option value="Sosiologi (S1)">Sosiologi (S1)</option>
                                        <option value="Sastra Inggris (S1)">Sastra Inggris (S1)</option>
                                        <option value="Ilmu Hukum (S1)">Ilmu Hukum (S1)</option>
                                    </optgroup>
                                    <optgroup label="FAKULTAS KEGURUAN DAN ILMU PENDIDIKAN (FKIP)">
                                        <option value="Pendidikan Bahasa dan Sastra Indonesia (S1)">Pendidikan Bahasa dan Sastra Indonesia (S1)</option>
                                        <option value="Pendidikan Bahasa Inggris (S1)">Pendidikan Bahasa Inggris (S1)</option>
                                        <option value="Pendidikan Biologi (S1)">Pendidikan Biologi (S1)</option>
                                        <option value="Pendidikan Fisika (S1)">Pendidikan Fisika (S1)</option>
                                        <option value="Pendidikan Kimia (S1)">Pendidikan Kimia (S1)</option>
                                        <option value="Pendidikan Matematika (S1)">Pendidikan Matematika (S1)</option>
                                        <option value="Pendidikan Pancasila dan Kewarganegaraan (S1)">Pendidikan Pancasila dan Kewarganegaraan (S1)</option>
                                        <option value="Pendidikan Ekonomi (S1)">Pendidikan Ekonomi (S1)</option>
                                        <option value="Teknologi Pendidikan (S1)">Teknologi Pendidikan (S1)</option>
                                        <option value="PGSD (Dalam Jabatan) (S1)">PGSD (Dalam Jabatan) (S1)</option>
                                        <option value="PGSD (Prajabatan) (S1)">PGSD (Prajabatan) (S1)</option>
                                        <option value="PGPAUD (Dalam Jabatan) (S1)">PGPAUD (Dalam Jabatan) (S1)</option>
                                        <option value="PGPAUD (Prajabatan) (S1)">PGPAUD (Prajabatan) (S1)</option>
                                        <option value="Pendidikan Profesi Guru (PPG)">Pendidikan Profesi Guru (PPG)</option>
                                        <option value="Pendidikan Agama Islam (PAI)">Pendidikan Agama Islam (PAI)</option>
                                    </optgroup>
                                    <optgroup label="FAKULTAS SAINS DAN TEKNOLOGI (FST)">
                                        <option value="Matematika (S1)">Matematika (S1)</option>
                                        <option value="Statistika (S1)">Statistika (S1)</option>
                                        <option value="Biologi (S1)">Biologi (S1)</option>
                                        <option value="Perencanaan Wilayah dan Kota (S1)">Perencanaan Wilayah dan Kota (S1)</option>
                                        <option value="Sistem Informasi (S1)">Sistem Informasi (S1)</option>
                                        <option value="Sains Data (S1)">Sains Data (S1)</option>
                                        <option value="Agribisnis (S1)">Agribisnis (S1)</option>
                                        <option value="Teknologi Pangan (S1)">Teknologi Pangan (S1)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Status</label>
                                <select name="status" value={mahasiswaForm.status} onChange={handleMahasiswaFormChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Mahasiswa Baru">Mahasiswa Baru</option>
                                    <option value="Aktif">Aktif</option>
                                    <option value="Cuti">Cuti</option>
                                    <option value="Wisuda">Wisuda</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Jenis Layanan</label>
                                <select name="jenisLayanan" value={mahasiswaForm.jenisLayanan} onChange={handleMahasiswaFormChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="SIPAS Penuh">SIPAS Penuh</option>
                                    <option value="SIPAS Semi">SIPAS Semi</option>
                                    <option value="SIPAS Non-TTM">SIPAS Non-TTM</option>
                                    <option value="Non-SIPAS">Non-SIPAS</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Semester</label>
                                <input type="number" name="semester" value={mahasiswaForm.semester} onChange={handleMahasiswaFormChange} min="1" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Lokasi Ujian</label>
                                <input type="text" name="lokasiUjian" value={mahasiswaForm.lokasiUjian} onChange={handleMahasiswaFormChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                        </div>
                        <div className="flex space-x-4 mt-4">
                            <button type="submit" disabled={isSaving} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all disabled:opacity-50">
                                {mahasiswaForm.id ? 'Simpan Perubahan' : 'Tambah Mahasiswa'}
                            </button>
                            {mahasiswaForm.id && (
                                <button type="button" onClick={resetMahasiswaForm} className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all">
                                    Batal
                                </button>
                            )}
                        </div>
                    </form>

                    <h2 className="text-2xl font-semibold mt-8 mb-4 text-gray-900">Impor/Unduh Data Mahasiswa via Excel</h2>
                    <p className="text-gray-600 mb-4">Gunakan templat untuk memastikan format data yang benar, lalu unggah file Anda.</p>
                    <div className="flex items-center space-x-4 mb-6 p-4 border rounded-lg bg-gray-50">
                        {xlsxLoaded ? (
                            <>
                                <button onClick={handleDownloadSampleTemplate} className="flex items-center gap-2 px-6 py-3 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors">
                                    <FilePlus size={20} />
                                    Unduh Templat
                                </button>
                                <label className="flex items-center gap-2 px-6 py-3 rounded-lg bg-purple-600 text-white font-semibold cursor-pointer hover:bg-purple-700 transition-colors">
                                    <Upload size={20} />
                                    Impor dari Excel
                                    <input type="file" accept=".xlsx" onChange={handleFileUpload} className="hidden" />
                                </label>
                            </>
                        ) : (
                            <div className="flex items-center gap-2 text-gray-500 italic">
                                <div className="w-5 h-5 border-2 border-gray-300 border-solid rounded-full animate-spin border-t-transparent"></div>
                                Memuat library Excel...
                            </div>
                        )}
                    </div>

                    <h2 className="text-2xl font-semibold mb-4 text-gray-700">Daftar Mahasiswa</h2>
                    
                    <div className="flex flex-wrap items-center gap-2 mb-4 p-4 rounded-lg bg-gray-50 border">
                        <span className="text-sm font-semibold text-gray-700">Filter:</span>
                        {['Semua', 'Mahasiswa Baru', 'Aktif', 'Cuti', 'Wisuda'].map(status => (
                            <button
                                key={status}
                                onClick={() => setCurrentFilter(status)}
                                className={`px-4 py-2 rounded-lg transition-all shadow-sm ${currentFilter === status ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                            >
                                {status}
                            </button>
                        ))}
                        <button
                            onClick={generateCategoryPDF}
                            disabled={!pdfLoaded || isGeneratingPdf}
                            className={`flex items-center px-4 py-2 rounded-lg transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed ${isGeneratingPdf ? 'bg-gray-400 text-white' : 'bg-indigo-600 text-white hover:bg-indigo-700'}`}
                        >
                            <FileText size={16} className="mr-2" />
                            Simpan PDF
                        </button>
                        {isGeneratingPdf && (
                            <div className="ml-4 flex items-center text-sm text-gray-500">
                                <div className="w-5 h-5 border-2 border-gray-300 border-solid rounded-full animate-spin border-t-transparent mr-2"></div>
                                Membuat PDF...
                            </div>
                        )}
                    </div>

                    <div className="overflow-x-auto rounded-lg shadow-md">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIM</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jurusan</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semester</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi Ujian</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {getFilteredStudents().length > 0 ? (
                                    getFilteredStudents().map(student => (
                                        <tr key={student.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{student.nim}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.nama}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.jurusan}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.status}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.semester}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.lokasiUjian}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                                                <button onClick={() => editMahasiswa(student.id)} className="text-indigo-600 hover:text-indigo-900 transition-colors">
                                                    <Edit size={16} className="inline-block mr-1" />
                                                    Edit
                                                </button>
                                                <button onClick={() => { setStudentToDelete(student.id); setShowDeleteModal(true); }} className="text-red-600 hover:text-red-900 transition-colors">
                                                    <Trash2 size={16} className="inline-block mr-1" />
                                                    Hapus
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                ) : (
                                    <tr>
                                        <td colSpan="7" className="px-6 py-4 text-center text-sm text-gray-500">Tidak ada data mahasiswa.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Bagian Pembayaran */}
            {currentSection === 'pembayaran' && (
                <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-10 mb-10">
                    <h2 className="text-2xl font-semibold mb-4 text-gray-900">Input Pembayaran</h2>
                    <div className="mb-6 p-4 border rounded-lg bg-gray-50 flex flex-col md:flex-row gap-4 items-end">
                        <div className="flex-grow w-full">
                            <label className="block text-sm font-medium text-gray-700">Cari NIM atau Nama</label>
                            <input type="text" value={paymentSearchQuery} onChange={(e) => setPaymentSearchQuery(e.target.value)} placeholder="Masukkan NIM atau Nama" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                        <button onClick={searchStudentForPayment} className="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all">
                            Cari
                        </button>
                    </div>

                    {paymentStudent && (
                        <div className="border-2 border-black p-6 rounded-lg">
                            <div className="p-4 bg-blue-50 rounded-lg mb-4">
                                <h3 className="text-xl font-bold mb-2">{paymentStudent.nama}</h3>
                                <p className="text-gray-600">NIM: {paymentStudent.nim}</p>
                                <p className="text-gray-600">Siklus Pembayaran: {formatDate(paymentStudent.currentPaymentCycle.periodStart)} sampai {formatDate(paymentStudent.currentPaymentCycle.periodEnd)}</p>
                            </div>
                            <form onSubmit={savePayment} className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Nominal Layanan Salut</label>
                                        <select name="nominalSalut" value={paymentForm.nominalSalut} onChange={handlePaymentFormChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white focus:ring-purple-500 focus:border-purple-500">
                                            <option value="">-- Pilih Nominal --</option>
                                            <option value="400000">Luar Wilayah (Rp400.000)</option>
                                            <option value="500000">Dalam Wilayah (Rp500.000)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Nominal Cicilan</label>
                                        <input type="number" name="cicilSalut" value={paymentForm.cicilSalut} onChange={handlePaymentFormChange} placeholder="Masukkan nominal pembayaran" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Sisa Pembayaran</label>
                                        <input type="text" value={formatRupiah(updateSisaSalut())} readOnly className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-200 font-bold" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Keterangan Pembayaran</label>
                                        <input type="text" name="keteranganSalut" value={paymentForm.keteranganSalut} onChange={handlePaymentFormChange} placeholder="Contoh: Cicilan pertama" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Tanggal Pembayaran Salut</label>
                                        <input type="date" name="tanggalSalut" value={paymentForm.tanggalSalut} onChange={handlePaymentFormChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Tanggal Pembayaran SPP</label>
                                        <input type="date" name="tanggalSpp" value={paymentForm.tanggalSpp} onChange={handlePaymentFormChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500" />
                                    </div>
                                </div>
                                <button type="submit" disabled={isSaving} className="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all disabled:opacity-50">
                                    Simpan Pembayaran
                                </button>
                            </form>
                        </div>
                    )}
                </div>
            )}

            {/* Bagian Laporan Keuangan */}
            {currentSection === 'laporan-keuangan' && (
                <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-10 mb-10">
                    <h2 className="text-2xl font-semibold mb-6 text-gray-900">Laporan Keuangan Mahasiswa</h2>
                    
                    {/* Ringkasan Keuangan dalam kartu */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-blue-100 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                            <h3 className="text-xl font-bold text-blue-800">Total Pemasukan</h3>
                            <p className="mt-2 text-3xl font-extrabold text-blue-600">{formatRupiah(totalIncome)}</p>
                            <p className="text-sm text-blue-700">(Hanya Mahasiswa Aktif & Baru)</p>
                        </div>
                        <div className="bg-green-100 p-6 rounded-lg shadow-md border-l-4 border-green-500">
                            <h3 className="text-xl font-bold text-green-800">Pemasukan Mahasiswa Baru</h3>
                            <p className="mt-2 text-3xl font-extrabold text-green-600">{formatRupiah(totalIncomeNewStudents)}</p>
                        </div>
                        <div className="bg-purple-100 p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                            <h3 className="text-xl font-bold text-purple-800">Pemasukan Mahasiswa Lama</h3>
                            <p className="mt-2 text-3xl font-extrabold text-purple-600">{formatRupiah(totalIncomeOldStudents)}</p>
                        </div>
                    </div>

                    <div className="flex flex-wrap items-center gap-2 mb-4 p-4 rounded-lg bg-gray-50 border">
                        <span className="text-sm font-semibold text-gray-700">Filter:</span>
                        {['Semua', 'Lunas', 'Belum Lunas'].map(status => (
                            <button
                                key={status}
                                onClick={() => setCurrentKeuanganFilter(status)}
                                className={`px-4 py-2 rounded-lg transition-all shadow-sm ${currentKeuanganFilter === status ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                            >
                                {status}
                            </button>
                        ))}
                        <button
                            onClick={generateKeuanganPDF}
                            disabled={!pdfLoaded || isGeneratingKeuanganPdf}
                            className={`flex items-center px-4 py-2 rounded-lg transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed ${isGeneratingKeuanganPdf ? 'bg-gray-400 text-white' : 'bg-indigo-600 text-white hover:bg-indigo-700'}`}
                        >
                            <FileText size={16} className="mr-2" />
                            Simpan PDF
                        </button>
                        {isGeneratingKeuanganPdf && (
                            <div className="ml-4 flex items-center text-sm text-gray-500">
                                <div className="w-5 h-5 border-2 border-gray-300 border-solid rounded-full animate-spin border-t-transparent mr-2"></div>
                                Membuat PDF...
                            </div>
                        )}
                    </div>

                    <div className="overflow-x-auto rounded-lg shadow-md">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIM</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nominal Salut</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Cicilan</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sisa</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {getFilteredKeuangan().length > 0 ? (
                                    getFilteredKeuangan().map(student => (
                                        <tr key={student.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{student.nim}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.nama}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatRupiah(student.currentPaymentCycle?.nominalSalut || 0)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatRupiah(student.currentPaymentCycle?.cicilSalut || 0)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatRupiah(student.currentPaymentCycle?.sisaSalut || 0)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{student.currentPaymentCycle?.keteranganSalut || '-'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                                                {student.currentPaymentCycle?.nominalSalut > 0 && (
                                                    <>
                                                        <button onClick={() => showEditPayment(student)} className="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded-lg transition-colors">
                                                            <Edit size={16} className="inline-block" />
                                                        </button>
                                                        <button onClick={() => showFinancialReport(student)} className="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg transition-colors">
                                                            <Eye size={16} className="inline-block" />
                                                        </button>
                                                        <button 
                                                            onClick={() => generateFinancialReportPdf(student)}
                                                            disabled={isGeneratingReportPdf}
                                                            className={`bg-red-500 text-white px-3 py-1 rounded-lg transition-colors ${isGeneratingReportPdf ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-600'}`}>
                                                            <FileText size={16} className="inline-block" />
                                                        </button>
                                                    </>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                ) : (
                                    <tr>
                                        <td colSpan="7" className="px-6 py-4 text-center text-sm text-gray-500">Tidak ada data keuangan untuk mahasiswa aktif.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Modals */}
            {/* Modal Hapus */}
            <div className={`fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 ${showDeleteModal ? '' : 'hidden'}`}>
                <div className="bg-white rounded-lg shadow-xl p-6 w-96 max-w-full">
                    <h3 className="text-xl font-bold mb-4">Konfirmasi Penghapusan</h3>
                    <p className="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus data mahasiswa ini? Tindakan ini tidak dapat dibatalkan.</p>
                    <div className="flex justify-end space-x-4">
                        <button onClick={() => setShowDeleteModal(false)} className="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Batal</button>
                        <button onClick={handleDelete} disabled={isSaving} className="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 disabled:opacity-50">Hapus</button>
                    </div>
                </div>
            </div>

            {/* Modal Pesan */}
            <div className={`fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 ${showMessageModal ? '' : 'hidden'}`}>
                <div className={`bg-white rounded-lg shadow-xl p-6 w-96 max-w-full border-t-4 ${messageModalContent.type === 'success' ? 'border-green-500' : messageModalContent.type === 'error' ? 'border-red-500' : 'border-blue-500'}`}>
                    <div className="flex justify-between items-start mb-4">
                        <h3 className="text-xl font-bold text-gray-800">{messageModalContent.title}</h3>
                        <button onClick={() => setShowMessageModal(false)} className="text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    <p className="text-gray-600 mb-6">{messageModalContent.text}</p>
                    <div className="flex justify-end">
                        <button onClick={() => setShowMessageModal(false)} className={`px-4 py-2 rounded-lg ${messageModalContent.type === 'success' ? 'bg-green-600' : messageModalContent.type === 'error' ? 'bg-red-600' : 'bg-blue-600'} text-white`}>Tutup</button>
                    </div>
                </div>
            </div>

            {/* Modal Edit Pembayaran */}
            <div className={`fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 ${showEditPaymentModal ? '' : 'hidden'}`}>
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                    <div className="flex justify-between items-center">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">Edit Pembayaran Mahasiswa</h3>
                        <button onClick={() => setShowEditPaymentModal(false)} className="text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    {editPaymentStudent && (
                        <form onSubmit={updateEditedPayment} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Nama Mahasiswa</label>
                                <p className="mt-1 font-bold">{editPaymentStudent.nama} ({editPaymentStudent.nim})</p>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Nominal Total</label>
                                <input type="text" value={formatRupiah(editPaymentStudent.currentPaymentCycle?.nominalSalut)} readOnly className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-200 font-bold" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Total Cicilan Saat Ini</label>
                                <input type="number" value={editPaymentAmount} onChange={(e) => setEditPaymentAmount(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Sisa Pembayaran</label>
                                <input type="text" value={formatRupiah(editPaymentStudent.currentPaymentCycle?.nominalSalut - editPaymentAmount)} readOnly className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-200 font-bold" />
                            </div>
                            <div className="flex justify-between items-center mt-6">
                                <button type="button" onClick={markAsLunas} disabled={isSaving} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all disabled:opacity-50">
                                    <Check size={16} className="inline-block mr-2"/>
                                    Tandai Lunas
                                </button>
                                <div className="space-x-2">
                                    <button type="button" onClick={() => setShowEditPaymentModal(false)} className="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Batal</button>
                                    <button type="submit" disabled={isSaving} className="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50">Simpan Perubahan</button>
                                </div>
                            </div>
                        </form>
                    )}
                </div>
            </div>

            {/* Modal Impor Excel */}
            <div className={`fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 ${showImportModal ? '' : 'hidden'}`}>
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-gray-800">Pratinjau Data Impor</h3>
                        <button onClick={() => setShowImportModal(false)} className="text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    {importedData.length > 0 ? (
                        <>
                            <p className="text-gray-600 mb-4">Ditemukan {importedData.length} entri data. Mohon konfirmasi data di bawah ini sebelum menyimpan.</p>
                            <div className="overflow-x-auto max-h-96 mb-4 rounded-lg border">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            {importedData.length > 0 && Object.keys(importedData[0]).map(key => (
                                                <th key={key} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{key}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {importedData.map((row, index) => (
                                            <tr key={index}>
                                                {Object.values(row).map((value, idx) => (
                                                    <td key={idx} className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{value}</td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="flex justify-end space-x-4">
                                <button onClick={() => setShowImportModal(false)} className="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Batal</button>
                                <button onClick={saveImportedData} disabled={isSaving} className="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:opacity-50">
                                    <Upload size={16} className="inline-block mr-2" />
                                    Simpan Semua Data
                                </button>
                            </div>
                        </>
                    ) : (
                        <p className="text-gray-600">Tidak ada data untuk dipratinjau.</p>
                    )}
                </div>
            </div>
            
            {/* Modal Laporan Keuangan Dinamis */}
            <div className={`fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 ${showReportModal ? '' : 'hidden'}`}>
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
                    <div className="flex justify-between items-start mb-4">
                        <h3 className="text-2xl font-bold text-gray-800">Laporan Keuangan Mahasiswa</h3>
                        <button onClick={() => setShowReportModal(false)} className="text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    {reportStudent && (
                        <>
                            <div className="mb-6 space-y-1 text-gray-700">
                                <p><strong>Nama Mahasiswa:</strong> {reportStudent.nama}</p>
                                <p><strong>NIM:</strong> {reportStudent.nim}</p>
                                <p><strong>Jurusan:</strong> {reportStudent.jurusan}</p>
                                <p><strong>Periode Akademik:</strong> Semester {reportStudent.semester}</p>
                            </div>

                            <div className="overflow-x-auto rounded-lg shadow-md mb-4">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Biaya</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah (Rp)</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Layanan SALUT</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatRupiah(reportStudent.currentPaymentCycle?.nominalSalut || 0)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium" style={{ color: reportStudent.currentPaymentCycle?.sisaSalut === 0 ? '#10B981' : '#EF4444' }}>
                                                {reportStudent.currentPaymentCycle?.sisaSalut === 0 ? 'LUNAS' : 'BELUM LUNAS'}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {reportStudent.currentPaymentCycle?.sisaSalut === 0 ? `Pembayaran lunas.` : `Sisa ${formatRupiah(reportStudent.currentPaymentCycle?.sisaSalut || 0)}`}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded-lg text-sm text-gray-700">
                                <p><strong>Ringkasan Pembayaran:</strong></p>
                                <ul className="list-disc list-inside mt-2 space-y-1">
                                    <li>Total Biaya: {formatRupiah(reportStudent.currentPaymentCycle?.nominalSalut || 0)}</li>
                                    <li>Total Pembayaran Diterima: {formatRupiah(reportStudent.currentPaymentCycle?.cicilSalut || 0)}</li>
                                    <li>Sisa Kewajiban: {formatRupiah((reportStudent.currentPaymentCycle?.nominalSalut || 0) - (reportStudent.currentPaymentCycle?.cicilSalut || 0))}</li>
                                </ul>
                            </div>

                        </>
                    )}
                    <div className="flex justify-end mt-4">
                        <button onClick={() => setShowReportModal(false)} className="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Tutup</button>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default App;
